<!DOCTYPE html>
<html>
<head>
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <style> /* Your existing styles */ </style>
</head>
<body>
    <h1>ğŸ”— P2P WebRTC (No Server)</h1>
    
    <div>
        <button onclick="getLocalOffer()">ğŸ“¤ Generate Offer</button>
        <button onclick="getLocalAnswer()">ğŸ“¤ Generate Answer</button>
        <textarea id="copyData" rows="6" placeholder="Copy this â†’ Send to peer â†’ They paste here" readonly></textarea>
        <br>
        <input id="pasteData" placeholder="Paste peer's data here" />
        <button onclick="useRemoteData()">ğŸ“¥ Use Data</button>
    </div>
    
    <div id="status">Ready</div>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        Telegram.WebApp.ready(); Telegram.WebApp.expand();
        const statusEl = document.getElementById('status');
        const copyEl = document.getElementById('copyData');
        const pasteEl = document.getElementById('pasteData');
        let pc, localStream;

        const config = { iceServers: [{urls: 'stun:stun.l.google.com:19302'}] };

        // 1. GENERATE OFFER/ANSWER â†’ COPY STRING
        async function getLocalOffer() {
            await setupMedia();
            pc = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            pc.onicecandidate = e => { if (e.candidate) updateCopyData(); };
            
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            statusEl.textContent = 'âœ… Copy & send to peer';
        }

        async function getLocalAnswer() {
            const data = JSON.parse(pasteEl.value);
            await setupMedia();
            pc = new RTCPeerConnection(config);
            // ... same setup as offer
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            statusEl.textContent = 'âœ… Copy & send answer back';
        }

        // 2. COMPACT DATA SERIALIZATION
        function updateCopyData() {
            const data = {
                offer: pc.localDescription.sdp,  // ~1-2KB
                candidates: pc.getSenders().map(s => s.transport.iceGatherer.getIceCandidates())
            };
            const compact = btoa(JSON.stringify(data));  // Base64 â†’ ~2KB
            copyEl.value = compact;
            navigator.clipboard.writeText(compact);
            statusEl.textContent += ' (Copied!)';
        }

        // 3. USE PEER'S PASTED DATA
        async function useRemoteData() {
            try {
                const data = JSON.parse(atob(pasteEl.value));
                pc = new RTCPeerConnection(config);
                
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                await pc.setLocalDescription(await pc.createAnswer());
                
                data.candidates.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)));
                statusEl.textContent = 'âœ… Connected!';
            } catch(e) {
                statusEl.textContent = 'âŒ Invalid data';
            }
        }

        async function setupMedia() {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('localVideo').srcObject = localStream;
        }
    </script>
</body>
</html>
