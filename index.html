<!DOCTYPE html>
<html>
<head>
    <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px; 
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            text-align: center;
            line-height: 1.4;
        }
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0 0 20px 0;
            color: var(--tg-theme-text-color);
        }
        button { 
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff) !important;
            border: none; 
            padding: 14px 20px; 
            border-radius: 12px; 
            font-size: 16px;
            font-weight: 500;
            cursor: pointer; 
            margin: 8px;
            width: 100%;
            max-width: 320px;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-appearance: none;
        }
        button:hover {
            background: var(--tg-theme-button-color);
            opacity: 0.9;
        }
        button:active {
            transform: scale(0.98);
        }
        textarea, input {
            width: 100%; max-width: 400px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--tg-theme-hint-color, #c7c7c7);
            background: var(--tg-theme-secondary-bg-color, #f8f8f8);
            color: var(--tg-theme-text-color);
            font-size: 15px;
            margin: 8px 0;
            resize: vertical;
            font-family: inherit;
        }
        textarea {
            min-height: 120px;
            font-size: 14px;
        }
        textarea[readonly] {
            background: var(--tg-theme-hint-color);
            opacity: 0.7;
        }
        #status { 
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 500;
            background: var(--tg-theme-secondary-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
        }
        video { 
            width: 100%; 
            max-height: 200px; 
            border-radius: 12px; 
            margin: 12px 0;
            background: var(--tg-theme-hint-color);
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”— P2P WebRTC Call</h1>
        
        <div>
            <!-- Make buttons also copy when offer/answer ready -->
            <button onclick="getLocalOffer()" id="offerBtn">ðŸ“¤ Create Offer</button>
            <button onclick="getLocalAnswer()" id="answerBtn">ðŸ“¤ Create Answer</button>

        </div>
        
        <textarea id="copyData" 
                placeholder="Tap to copy!" 
                readonly 
                onclick="copyToClipboard()"
                onfocus="copyToClipboard()"></textarea>

        <!-- Add copy feedback -->
        <div id="copyFeedback" style="display:none; padding:12px; border-radius:12px; background:var(--tg-theme-button-color); color:var(--tg-theme-button-text-color); margin:8px 0; font-weight:500;"></div>
        
        <div>
            <input id="pasteData" placeholder="Paste peer's offer/answer here..." />
            <button onclick="useRemoteData()">ðŸ“¥ 3. Use Data</button>
        </div>
        
        <div id="status">Ready to create an offer</div>
        
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        
        // Dynamic theme matching
        document.documentElement.style.setProperty('--tg-theme-bg-color', Telegram.WebApp.themeParams.bg_color);
        document.documentElement.style.setProperty('--tg-theme-text-color', Telegram.WebApp.themeParams.text_color);
        document.documentElement.style.setProperty('--tg-theme-button-color', Telegram.WebApp.themeParams.button_color);
        document.documentElement.style.setProperty('--tg-theme-button-text-color', Telegram.WebApp.themeParams.button_text_color);
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', Telegram.WebApp.themeParams.secondary_bg_color);
        document.documentElement.style.setProperty('--tg-theme-hint-color', Telegram.WebApp.themeParams.hint_color);

        const statusEl = document.getElementById('status');
        const copyEl = document.getElementById('copyData');
        const pasteEl = document.getElementById('pasteData');
        let pc, localStream;

        const config = { 
            iceServers: [{urls: 'stun:stun.l.google.com:19302'}] 
        };

        async function copyToClipboard() {
            const copyEl = document.getElementById('copyData');
            const feedbackEl = document.getElementById('copyFeedback');
            
            if (copyEl.value) {
                try {
                    await navigator.clipboard.writeText(copyEl.value);
                    
                    // Telegram haptic feedback
                    if (Telegram.WebApp.HapticFeedback) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    }
                    
                    // Visual feedback
                    feedbackEl.textContent = 'âœ… Copied to clipboard!';
                    feedbackEl.style.display = 'block';
                    setTimeout(() => { feedbackEl.style.display = 'none'; }, 2000);
                    
                } catch (err) {
                    feedbackEl.textContent = 'âŒ Copy failed';
                    feedbackEl.style.display = 'block';
                }
            }
        }
        // Auto-copy styling for buttons
        document.getElementById('offerBtn').addEventListener('click', () => {
            setTimeout(() => {
                if (document.getElementById('copyData').value) {
                    copyToClipboard();
                }
            }, 1500); // After ICE gathering
        });


        // Update updateCopyData() to trigger auto-copy
        function updateCopyData() {
            if (!pc || !pc.localDescription) return;
            
            const data = { sdp: pc.localDescription.sdp };
            const compact = btoa(JSON.stringify(data));
            document.getElementById('copyData').value = compact;
            
            // Auto-copy immediately
            copyToClipboard();
        }


        async function setupMedia() {
            try {
                statusEl.textContent = 'Requesting camera permission...';
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    // { 
                    //     width: { ideal: 640 }, 
                    //     height: { ideal: 480 }, 
                    //     facingMode: 'user' 
                    // }, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                statusEl.textContent = 'âœ… Camera ready';
                return true;
            } catch (err) {
                console.error('Camera error:', err);
                statusEl.textContent = `âŒ Camera denied: ${err.name}`;
                if (err.name === 'NotAllowedError') {
                    statusEl.textContent += '\nPlease enable camera in browser permissions';
                }
                return false;
            }
        }

        async function getLocalOffer() {
            const mediaReady = await setupMedia();
            if (!mediaReady) return;
            
            try {
                statusEl.textContent = 'Creating connection...';
                pc = new RTCPeerConnection(config);
                
                // Add tracks only after camera is confirmed working
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                
                pc.ontrack = e => {
                    document.getElementById('remoteVideo').srcObject = e.streams[0];
                    statusEl.textContent = 'âœ… Waiting for peer video...';
                };
                
                pc.onicecandidate = () => {
                    if (pc.iceGatheringState === 'complete') {
                        updateCopyData();
                    }
                };
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
            } catch (err) {
                statusEl.textContent = `âŒ Setup failed: ${err.message}`;
            }
        }


        async function getLocalAnswer() {
            try {
                const remoteData = JSON.parse(atob(pasteEl.value));
                statusEl.textContent = 'Setting up...';
                
                await setupMedia();
                pc = new RTCPeerConnection(config);
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                
                pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
                pc.onicecandidate = updateCopyData;
                
                await pc.setRemoteDescription(new RTCSessionDescription({type: 'offer', sdp: remoteData.sdp}));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                statusEl.textContent = 'âœ… Answer ready! Copy & send back';
            } catch(e) {
                statusEl.textContent = 'âŒ Invalid data pasted';
            }
        }

        function updateCopyData() {
            if (!pc || !pc.localDescription) return;
            
            const data = {
                sdp: pc.localDescription.sdp,
                candidates: Array.from(pc.getSenders()).map(s => s.transport?.iceGatherer?.getIceCandidates?.() || [])
            };
            
            const compact = btoa(JSON.stringify(data));
            copyEl.value = compact;
            navigator.clipboard.writeText(compact).then(() => {
                statusEl.textContent += ' (Copied to clipboard!)';
            });
        }

        async function useRemoteData() {
            try {
                const data = JSON.parse(atob(pasteEl.value));
                if (!pc) {
                    await setupMedia();
                    pc = new RTCPeerConnection(config);
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                    pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
                }
                
                await pc.setRemoteDescription(new RTCSessionDescription({type: 'answer', sdp: data.sdp}));
                data.candidates.forEach(candidates => {
                    candidates.forEach(candidate => {
                        if (candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                });
                statusEl.textContent = 'âœ… Data applied! Check video';
            } catch(e) {
                statusEl.textContent = 'âŒ Invalid data format';
            }
        }

        // Auto-expand and theme updates
        Telegram.WebApp.onEvent('themeChanged', () => {
            document.documentElement.style.setProperty('--tg-theme-bg-color', Telegram.WebApp.themeParams.bg_color);
            document.documentElement.style.setProperty('--tg-theme-text-color', Telegram.WebApp.themeParams.text_color);
            // ... other theme params
        });
    </script>
</body>
</html>
